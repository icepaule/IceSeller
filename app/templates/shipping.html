{% extends "base.html" %}

{% set active_page = 'orders' %}

{% block title %}Versand - Bestellung #{{ order.id }} - IceSeller{% endblock %}

{% block content %}
<!-- Toast container -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3"></div>

<!-- Spinner overlay -->
<div id="spinner-overlay" class="spinner-overlay">
    <div class="text-center">
        <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Wird erstellt...</span>
        </div>
        <div class="spinner-message text-white mt-3 fs-5">DHL Versandlabel wird erstellt...</div>
    </div>
</div>

<div class="row g-3">

    <!-- Breadcrumb -->
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/orders/" class="text-decoration-none">Bestellungen</a></li>
                <li class="breadcrumb-item"><a href="/orders/{{ order.id }}" class="text-decoration-none">Bestellung #{{ order.id }}</a></li>
                <li class="breadcrumb-item active">Versand</li>
            </ol>
        </nav>
    </div>

    <!-- Left column: order summary -->
    <div class="col-lg-5">

        <!-- Buyer info -->
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header">
                <i class="bi bi-person"></i> Kaeufer
            </div>
            <div class="card-body">
                <h5 class="mb-2">{{ order.buyer_name or order.buyer_username or 'Unbekannt' }}</h5>
                {% if order.buyer_address %}
                <address class="text-muted mb-0">
                    {{ order.buyer_address.get('street', '') }}<br>
                    {% if order.buyer_address.get('street2') %}
                    {{ order.buyer_address.get('street2') }}<br>
                    {% endif %}
                    {{ order.buyer_address.get('postal_code', '') }} {{ order.buyer_address.get('city', '') }}<br>
                    {{ order.buyer_address.get('country', '') }}
                </address>
                {% else %}
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Keine Lieferadresse vorhanden
                </p>
                {% endif %}
            </div>
        </div>

        <!-- Item info -->
        {% if item %}
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header">
                <i class="bi bi-box-seam"></i> Artikel
            </div>
            <div class="card-body">
                <div class="d-flex gap-3">
                    {% if item.images %}
                    <img src="/data/images/{{ item.images[0] }}"
                         alt="Artikelbild"
                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px; background: #111;">
                    {% endif %}
                    <div>
                        <h6 class="mb-1">{{ item.confirmed_title or 'Ohne Titel' }}</h6>
                        <p class="text-muted small mb-0">
                            Artikel #{{ item.id }}
                            {% if order.total_price %}
                            &mdash; EUR {{ '%.2f'|format(order.total_price) }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- Right column: shipping details -->
    <div class="col-lg-7">

        <!-- Package info -->
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header">
                <i class="bi bi-truck"></i> Paketinformationen
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-0">
                    <tr>
                        <td class="text-muted" style="width: 180px;">Gewicht</td>
                        <td>
                            {% if item and item.weight_g %}
                            {{ item.weight_g }}g ({{ '%.1f'|format(item.weight_g / 1000) }} kg)
                            {% else %}
                            <span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Nicht angegeben (Standard: 1 kg)</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if shipping_info %}
                    <tr>
                        <td class="text-muted">DHL Service</td>
                        <td>
                            {% if shipping_info.get('error') %}
                            <span class="text-danger">{{ shipping_info.error }}</span>
                            {% else %}
                            {{ shipping_info.service }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Versandkosten</td>
                        <td class="fw-bold">
                            {% if shipping_info.cost > 0 %}
                            EUR {{ '%.2f'|format(shipping_info.cost) }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Shipping documents -->
        <div class="card bg-dark border-secondary mb-3">
            <div class="card-header">
                <i class="bi bi-file-earmark-text"></i> Versandpapiere drucken
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="/shipping/{{ order.id }}/packing-slip" target="_blank" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-card-list"></i> Lieferschein
                    </a>
                    <a href="/shipping/{{ order.id }}/address-label" target="_blank" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-envelope"></i> Adresslabel
                    </a>
                    <a href="/shipping/{{ order.id }}/invoice" target="_blank" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-receipt"></i> Rechnung
                    </a>
                </div>
            </div>
        </div>

        <!-- Create label section (before label is created) -->
        <div id="create-label-section">
            {% if order.fulfillment_status == 'pending' %}
            <div class="card bg-dark border-warning mb-3">
                <div class="card-body text-center py-4">
                    <i class="bi bi-printer text-warning" style="font-size: 2.5rem;"></i>
                    <h5 class="mt-3">Versandlabel erstellen</h5>
                    <p class="text-muted">
                        Erstelle ein DHL Versandlabel fuer diese Bestellung.
                        Die Sendungsnummer wird automatisch an eBay gemeldet.
                    </p>
                    {% if order.buyer_address %}
                    <button id="btn-create-label" class="btn btn-warning btn-lg" onclick="createLabel({{ order.id }})">
                        <i class="bi bi-printer"></i> DHL Versandlabel erstellen
                    </button>
                    {% else %}
                    <button class="btn btn-secondary btn-lg" disabled>
                        <i class="bi bi-exclamation-triangle"></i> Keine Lieferadresse
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Label result section (after label is created) -->
        <div id="label-result-section" style="display: none;">
            <div class="card bg-dark border-success mb-3">
                <div class="card-header text-success">
                    <i class="bi bi-check-circle"></i> Versandlabel erstellt
                </div>
                <div class="card-body">
                    <table class="table table-dark table-sm mb-3">
                        <tr>
                            <td class="text-muted" style="width: 180px;">Sendungsnummer</td>
                            <td><code id="tracking-number" class="text-success fs-5"></code></td>
                        </tr>
                    </table>
                    <div class="d-flex gap-2 flex-wrap">
                        <a id="label-download" href="#" target="_blank" rel="noopener" class="btn btn-success">
                            <i class="bi bi-download"></i> Label PDF herunterladen
                        </a>
                        <a id="tracking-link" href="#" target="_blank" rel="noopener" class="btn btn-outline-warning">
                            <i class="bi bi-geo-alt"></i> Sendungsverfolgung
                        </a>
                        <a href="/orders/{{ order.id }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Zur Bestellung
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Show existing tracking if already shipped -->
        {% if order.fulfillment_status == 'shipped' and order.dhl_tracking %}
        <div class="card bg-dark border-success mb-3">
            <div class="card-header text-success">
                <i class="bi bi-check-circle"></i> Bereits versendet
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-3">
                    <tr>
                        <td class="text-muted" style="width: 180px;">Sendungsnummer</td>
                        <td><code class="text-success fs-5">{{ order.dhl_tracking }}</code></td>
                    </tr>
                    {% if order.shipped_at %}
                    <tr>
                        <td class="text-muted">Versendet am</td>
                        <td>{{ order.shipped_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    </tr>
                    {% endif %}
                </table>
                <div class="d-flex gap-2 flex-wrap">
                    {% if order.dhl_label_url %}
                    <a href="{{ order.dhl_label_url }}" target="_blank" rel="noopener" class="btn btn-outline-light">
                        <i class="bi bi-download"></i> Label herunterladen
                    </a>
                    {% endif %}
                    <a href="https://www.dhl.de/de/privatkunden/pakete-empfangen/verfolgen.html?piececode={{ order.dhl_tracking }}"
                       target="_blank" rel="noopener" class="btn btn-outline-warning">
                        <i class="bi bi-geo-alt"></i> Sendungsverfolgung
                    </a>
                    <a href="/orders/{{ order.id }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Zur Bestellung
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function createLabel(orderId) {
    var btn = document.getElementById('btn-create-label');
    if (btn) btn.disabled = true;

    showSpinner('DHL Versandlabel wird erstellt...');

    try {
        var response = await fetch('/shipping/' + orderId + '/create-label', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });

        hideSpinner();

        if (!response.ok) {
            var err = await response.json().catch(function() { return {detail: response.statusText}; });
            throw new Error(err.detail || 'Fehler beim Erstellen des Labels');
        }

        var data = await response.json();

        // Update UI
        document.getElementById('tracking-number').textContent = data.tracking_number;

        var labelDownload = document.getElementById('label-download');
        if (data.label_url) {
            labelDownload.href = data.label_url;
        } else {
            labelDownload.style.display = 'none';
        }

        var trackingLink = document.getElementById('tracking-link');
        trackingLink.href = 'https://www.dhl.de/de/privatkunden/pakete-empfangen/verfolgen.html?piececode=' + data.tracking_number;

        // Show result, hide create button
        document.getElementById('create-label-section').style.display = 'none';
        document.getElementById('label-result-section').style.display = 'block';

        showToast('Versandlabel erfolgreich erstellt! Sendungsnummer: ' + data.tracking_number, 'success');

    } catch (e) {
        hideSpinner();
        if (btn) btn.disabled = false;
        showToast('Fehler: ' + e.message, 'danger');
    }
}
</script>
{% endblock %}
