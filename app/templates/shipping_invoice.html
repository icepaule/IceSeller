<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rechnung {{ invoice_number }} - IceSeller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
            font-size: 10pt;
            color: #111;
            padding: 20mm;
            max-width: 210mm;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12mm;
        }
        .sender-block {
            font-size: 9pt;
            color: #555;
            line-height: 1.5;
        }
        .sender-block .name {
            font-weight: bold;
            color: #111;
            font-size: 12pt;
        }
        .invoice-title {
            text-align: right;
        }
        .invoice-title h1 {
            font-size: 22pt;
            font-weight: bold;
            margin-bottom: 2mm;
        }
        .invoice-title .invoice-nr {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
        }
        /* Address window position (DIN 5008) */
        .address-window {
            margin-bottom: 12mm;
        }
        .address-window .sender-line {
            font-size: 7pt;
            color: #999;
            text-decoration: underline;
            margin-bottom: 2mm;
        }
        .address-window .recipient {
            font-size: 11pt;
            line-height: 1.6;
        }
        .address-window .recipient .name { font-weight: bold; }
        /* Meta info */
        .meta-table {
            width: 100%;
            margin-bottom: 10mm;
        }
        .meta-table td {
            padding: 1mm 0;
            font-size: 9pt;
        }
        .meta-table td:first-child {
            color: #777;
            width: 120px;
        }
        /* Items table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 5mm;
        }
        .items-table th {
            background: #333;
            color: #fff;
            padding: 2.5mm 4mm;
            text-align: left;
            font-size: 9pt;
            font-weight: 600;
        }
        .items-table th.right { text-align: right; }
        .items-table td {
            padding: 3mm 4mm;
            border-bottom: 1px solid #ddd;
            vertical-align: top;
        }
        .items-table td.right { text-align: right; }
        .items-table .item-title { font-weight: 600; }
        .items-table .item-desc {
            font-size: 8pt;
            color: #888;
            margin-top: 1mm;
        }
        /* Totals */
        .totals-table {
            width: 50%;
            margin-left: auto;
            border-collapse: collapse;
            margin-bottom: 10mm;
        }
        .totals-table td {
            padding: 2mm 4mm;
            font-size: 10pt;
        }
        .totals-table td:first-child {
            text-align: right;
            color: #555;
        }
        .totals-table td:last-child { text-align: right; }
        .totals-table .total-row td {
            font-weight: bold;
            font-size: 12pt;
            border-top: 2px solid #333;
            padding-top: 3mm;
        }
        /* Tax notice */
        .tax-notice {
            font-size: 8pt;
            color: #888;
            margin-top: 8mm;
            padding-top: 5mm;
            border-top: 1px solid #ddd;
            line-height: 1.5;
        }
        .footer {
            position: fixed;
            bottom: 15mm;
            left: 20mm;
            right: 20mm;
            font-size: 8pt;
            color: #aaa;
            text-align: center;
            border-top: 1px solid #ddd;
            padding-top: 3mm;
        }
        @media print {
            body { padding: 15mm; }
            .no-print { display: none !important; }
        }
        @media screen {
            body { background: #f0f0f0; }
            .page {
                background: white;
                padding: 20mm;
                max-width: 210mm;
                margin: 10mm auto;
                box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            }
        }
        .print-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px 25px;
            background: #333;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
        }
        .print-btn:hover { background: #555; }
    </style>
</head>
<body>
<button class="print-btn no-print" onclick="window.print()">Drucken</button>
<div class="page">

    <div class="header">
        <div class="sender-block">
            <div class="name">{{ sender.name }}</div>
            {{ sender.street }}<br>
            {{ sender.postal_code }} {{ sender.city }}
        </div>
        <div class="invoice-title">
            <h1>Rechnung</h1>
            <div class="invoice-nr">{{ invoice_number }}</div>
        </div>
    </div>

    <!-- Address window -->
    <div class="address-window">
        <div class="sender-line">{{ sender.name }} &middot; {{ sender.street }} &middot; {{ sender.postal_code }} {{ sender.city }}</div>
        {% if order.buyer_address %}
        <div class="recipient">
            <div class="name">{{ order.buyer_address.get('name', '') }}</div>
            {{ order.buyer_address.get('street', '') }}<br>
            {% if order.buyer_address.get('street2') %}
            {{ order.buyer_address.get('street2') }}<br>
            {% endif %}
            {{ order.buyer_address.get('postal_code', '') }} {{ order.buyer_address.get('city', '') }}<br>
            {% if order.buyer_address.get('country', 'DE') != 'DE' %}
            {{ order.buyer_address.get('country', '') }}
            {% endif %}
        </div>
        {% else %}
        <div class="recipient" style="color: #c00;">Keine Adresse vorhanden</div>
        {% endif %}
    </div>

    <!-- Document meta -->
    <table class="meta-table">
        <tr>
            <td>Rechnungsdatum:</td>
            <td><strong>{{ today }}</strong></td>
        </tr>
        {% if order.sold_at %}
        <tr>
            <td>Kaufdatum:</td>
            <td>{{ order.sold_at.strftime('%d.%m.%Y') }}</td>
        </tr>
        {% endif %}
        {% if order.ebay_order_id %}
        <tr>
            <td>eBay Bestell-Nr.:</td>
            <td>{{ order.ebay_order_id }}</td>
        </tr>
        {% endif %}
        {% if order.buyer_username %}
        <tr>
            <td>eBay-Name:</td>
            <td>{{ order.buyer_username }}</td>
        </tr>
        {% endif %}
    </table>

    <!-- Items -->
    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 40px;">Pos.</th>
                <th>Bezeichnung</th>
                <th style="width: 50px;" class="right">Menge</th>
                <th style="width: 90px;" class="right">Einzelpreis</th>
                <th style="width: 90px;" class="right">Gesamt</th>
            </tr>
        </thead>
        <tbody>
            {% if item %}
            {% set item_price = (order.total_price or 0) - (order.shipping_cost or 0) %}
            <tr>
                <td>1</td>
                <td>
                    <div class="item-title">{{ item.confirmed_title or 'Ohne Titel' }}</div>
                    {% if item.internal_number %}
                    <div class="item-desc">Art.-Nr.: {{ item.internal_number }}</div>
                    {% endif %}
                </td>
                <td class="right">{{ item.quantity or 1 }}</td>
                <td class="right">{{ '%.2f'|format(item_price) }} EUR</td>
                <td class="right">{{ '%.2f'|format(item_price) }} EUR</td>
            </tr>
            {% if order.shipping_cost and order.shipping_cost > 0 %}
            <tr>
                <td>2</td>
                <td><div class="item-title">Versandkosten</div></td>
                <td class="right">1</td>
                <td class="right">{{ '%.2f'|format(order.shipping_cost) }} EUR</td>
                <td class="right">{{ '%.2f'|format(order.shipping_cost) }} EUR</td>
            </tr>
            {% endif %}
            {% endif %}
        </tbody>
    </table>

    <!-- Totals -->
    <table class="totals-table">
        {% if order.shipping_cost and order.shipping_cost > 0 %}
        <tr>
            <td>Artikelpreis:</td>
            <td>{{ '%.2f'|format((order.total_price or 0) - (order.shipping_cost or 0)) }} EUR</td>
        </tr>
        <tr>
            <td>Versand:</td>
            <td>{{ '%.2f'|format(order.shipping_cost) }} EUR</td>
        </tr>
        {% endif %}
        <tr class="total-row">
            <td>Gesamtbetrag:</td>
            <td>{{ '%.2f'|format(order.total_price or 0) }} EUR</td>
        </tr>
    </table>

    <!-- Tax notice (Kleinunternehmer) -->
    <div class="tax-notice">
        Gemaess &sect; 19 UStG wird keine Umsatzsteuer berechnet (Kleinunternehmerregelung).<br>
        Zahlung erfolgt ueber eBay Managed Payments. Vielen Dank fuer Ihren Einkauf!
    </div>

    <div class="footer">
        {{ sender.name }} &middot; {{ sender.street }} &middot; {{ sender.postal_code }} {{ sender.city }}
    </div>

</div>
</body>
</html>
